"use strict";var rr=Object.create;var I=Object.defineProperty;var tr=Object.getOwnPropertyDescriptor;var or=Object.getOwnPropertyNames;var nr=Object.getPrototypeOf,sr=Object.prototype.hasOwnProperty;var ir=(t,e)=>{for(var r in e)I(t,r,{get:e[r],enumerable:!0})},ge=(t,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of or(e))!sr.call(t,n)&&n!==r&&I(t,n,{get:()=>e[n],enumerable:!(o=tr(e,n))||o.enumerable});return t};var c=(t,e,r)=>(r=t!=null?rr(nr(t)):{},ge(e||!t||!t.__esModule?I(r,"default",{value:t,enumerable:!0}):r,t)),ar=t=>ge(I({},"__esModule",{value:!0}),t);var Dr={};ir(Dr,{default:()=>L});module.exports=ar(Dr);var R=c(require("path"));var he=c(require("path")),be=c(require("ws")),N=c(require("browser-extension-manifest-fields"));function A(t,e){t.clients.forEach(r=>{r.readyState===be.default.OPEN&&r.send(JSON.stringify(e))})}function z(t,e,r){if(!r||!e.manifestPath)return;let o=(0,N.default)(e.manifestPath).locales,n=(0,N.default)(e.manifestPath).scripts,s=(0,N.default)(e.manifestPath).json;he.default.basename(r)==="manifest.json"&&A(t,{changedFile:"manifest.json"}),o?.forEach(a=>{a.includes(r)&&A(t,{changedFile:"_locales"})}),Object.entries(n).forEach(([a,u])=>{let h=Array.isArray(u)?u:[u];Object.values(h).flatMap(v=>v).includes(r)&&a==="background/service_worker"&&A(t,{changedFile:"service_worker"})}),Object.entries(s).forEach(([a,u])=>{u?.includes(r)&&a==="declarative_net_request"&&A(t,{changedFile:"declarative_net_request"})})}var Re=c(require("ws"));var G=c(require("path")),l=require("console"),i=require("@colors/colors/safe"),we=c(require("prefers-yarn"));var V=c(require("fs")),xe=c(require("path"));function ye(t){let e=0,r=V.default.readdirSync(t);for(let o of r){let n=xe.default.join(t,o),s=V.default.statSync(n);s.isFile()?e+=s.size:s.isDirectory()&&(e+=ye(n))}return e}function J(t){let e=ye(t),r=["Bytes","KB","MB","GB","TB"],o=Math.floor(Math.log(e)/Math.log(1024));return`${(e/Math.pow(1024,o)).toFixed(1)} ${r[o]}`}function cr(t,e){let r=`Check the ${(0,i.bold)(t)} field in your manifest.json file and try again.`;return`[manifest.json] File path ${(0,i.underline)(e)} not found. ${r}`}function fr(){(0,l.log)(`
${(0,i.bold)("Error! Can't find the project's manifest file.")}

Check your extension ${(0,i.yellow)("manifest.json")} file and ensure its path points to
one of the options above, and try again.
`)}function lr(t,e,r){e.data||((0,l.error)(`[\u26D4\uFE0F] ${(0,i.bgWhite)((0,i.red)((0,i.bold)(" firefox-browser ")))} ${(0,i.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} No data received from client.

Ensure your extension is enabled and that no hanging Firefox instance is open then try again.`),process.exit(1));let o=t.options,{id:n,management:s}=e.data;s||process.env.EXTENSION_ENV==="development"&&(0,l.error)(`[\u26D4\uFE0F] ${(0,i.bgWhite)((0,i.red)((0,i.bold)(" firefox-browser ")))} ${(0,i.green)("\u25BA\u25BA\u25BA")} No management API info received from client. Investigate.`);let{name:a,description:u,version:h,hostPermissions:C,permissions:v}=s,U=G.default.join(o.context||"","manifest.json"),w=require(U),E=C?.filter($=>!$.startsWith("moz-extension://")),Ze=w.permissions||[],de=(v||[]).map($=>Ze.includes($)?$:`${$} (dev only)`),Qe=w.id===n,er=E&&E.length;(0,l.log)(""),(0,l.log)(`${(0,i.bold)("\u2022 Name:")} ${a}`),u&&(0,l.log)(`${(0,i.bold)("\u2022 Description:")} ${u}`),(0,l.log)(`${(0,i.bold)("\u2022 Version:")} ${h}`),(0,l.log)(`${(0,i.bold)("\u2022 Size:")} ${J(o.output.path||"dist")}`),(0,l.log)(`${(0,i.bold)("\u2022 ID:")} ${n} (${Qe?"permantent":"temporary"})`),er&&(0,l.log)(`${(0,i.bold)("\u2022 Host Permissions")}: ${E?.sort().join(", ")}`),(0,l.log)(`${(0,i.bold)("\u2022 Permissions:")} ${de.length?de.sort().join(", "):"(Using defaults)"}`)}function pr(t,e){let r=t.options,o=e.data?.management,n=(0,i.bgWhite)((0,i.red)((0,i.bold)(" firefox-browser "))),s=r.mode==="production"?i.magenta:i.cyan;(0,l.log)(`
${n} ${(0,i.green)("\u25BA\u25BA\u25BA")} Running Firefox in ${(0,i.bold)(s(r.mode||"unknown"))} mode. Browser ${o?.type} ${(0,i.bold)(o?.enabled?"enabled":"disabled")}.`)}function ur(){(0,l.log)(""),(0,l.log)("This is your first run using \u{1F9E9} Extension.js. Welcome! \u{1F389}"),(0,l.log)(`To start developing your extension, terminate this process and run ${(0,i.bold)((0,i.blue)((0,we.default)()?"yarn dev":"npm run dev"))}.`),(0,l.log)(`
Note: Firefox requires a certificate for secure WebSocket connections on localhost, `),(0,l.log)(`needed for the reloader to work. By default, your ${(0,i.yellow)("manifest.json")} file is not being watched.`),(0,l.log)(`
To enable this feature, run:`),(0,l.log)(`
  npx -y ${(0,i.bold)("mkcert-cli")} \\
    ${(0,i.green)("--outDir")} ${G.default.join(process.cwd(),"node_modules/webpack-run-firefox-addon/dist/certs")} \\
    ${(0,i.green)("--cert")} localhost.cert \\
    ${(0,i.green)("--key")} localhost.key
  `),(0,l.log)(`This will create a certificate in the plugin path via ${(0,i.bold)("mkcert")} and enable the secure connection for Firefox.`),(0,l.log)(`
\u{1F9E9} Learn more at ${(0,i.blue)((0,i.underline)("https://extension.js.org"))}`)}function mr(t,e){let r=e.toString();(0,l.log)(`[\u{1F613}] ${(0,i.bgWhite)((0,i.red)((0,i.bold)(" firefox-browser ")))} ${(0,i.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Watch mode closed (code ${t}). ${r&&`

Reason `+r+`
`}Exiting...
`)}function dr(t){(0,l.error)(`${(0,i.bgWhite)((0,i.red)((0,i.bold)(" firefox-browser ")))} ${(0,i.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Firefox not found at ${t}`)}function gr(t){t(`[\u26D4\uFE0F] ${(0,i.bgWhite)((0,i.red)((0,i.bold)(" firefox-browser ")))} ${(0,i.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} WebSocket error`,t)}function hr(t,e){t(`[\u26D4\uFE0F] ${(0,i.bgWhite)((0,i.red)((0,i.bold)(" firefox-browser ")))} ${(0,i.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Error parsing file: ${e}. Reason: ${t.message}`)}var g={manifestFieldError:cr,manifestNotFound:fr,extensionData:lr,stdoutData:pr,isFirstRun:ur,watchModeClosed:mr,browserNotFound:dr,webSocketError:gr,parseFileError:hr};var k=c(require("path")),Ee=c(require("https")),X=c(require("fs")),b=require("@colors/colors/safe"),ve=t=>{if(!X.default.existsSync(t))return;let e=k.default.basename(t);return X.default.readFileSync(k.default.join(__dirname,"certs",e))};function K(t=8002){let e={key:ve(k.default.join(__dirname,"certs","localhost.key")),cert:ve(k.default.join(__dirname,"certs","localhost.cert"))},r=Ee.default.createServer(e,(o,n)=>{n.writeHead(200)});return r.listen(t,"127.0.0.1"),r.on("error",o=>{throw o.code==="EADDRINUSE"&&console.error(`[\u{1F613}] ${(0,b.bgWhite)((0,b.red)((0,b.bold)(" firefox-browser ")))} ${(0,b.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Default port ${t} in use, choose a new port. + '
'
        }Exiting...
`),new Error(o.message)}),r}var $e=c(require("path")),ke=c(require("fs"));function x(){return!ke.default.existsSync($e.default.resolve(__dirname,"run-firefox-data-dir"))}function _e(t,e){let r=new Re.default.Server({server:K(e.port)}),o=x();return r.on("connection",n=>{n.send(JSON.stringify({status:"serverReady"})),n.on("error",s=>{g.webSocketError(s),r.close()}),n.on("close",(s,a)=>{o||g.watchModeClosed(s,a),r.close()}),n.on("message",s=>{let a=JSON.parse(s.toString());a.status==="clientReady"&&(e.stats===!0&&g.extensionData(t,a,o),g.stdoutData(t,a),e.stats===!0&&o&&setTimeout(()=>{g.isFirstRun()},2500))})}),r}var Se=c(require("path")),H=c(require("fs"));function Y(t){let e=Se.default.resolve(__dirname,"./extensions/reload-extension/reloadService.js");H.default.readFile(e,"utf8",(r,o)=>{if(r){console.error(`Error reading file: ${r.message}`);return}let n=o.replace(/__RELOAD_PORT__/g,t.toString());H.default.writeFile(e,n,"utf8",s=>{s&&console.error(`Error writing to file: ${s.message}`)})})}var Fe=c(require("path")),Z=c(require("fs"));function Q(){let t=x(),e=Fe.default.resolve(__dirname,"./extensions/manager-extension/initialTab.js");Z.default.readFile(e,"utf8",(r,o)=>{if(r){console.error(`Error reading file: ${r.message}`);return}let n=o.replace(/__IS_FIRST_RUN__ = false/g,`__IS_FIRST_RUN__ = ${t}`.toString());Z.default.writeFile(e,n,"utf8",s=>{s&&console.error(`Error writing to file: ${s.message}`)})})}var _=class{options;constructor(e){this.options=e}apply(e){if(!this.options.manifestPath)return;if(Y(this.options.port||8002),Q(),x()){let o=require(this.options.manifestPath);setTimeout(()=>{let n={data:{id:o.browser_specific_settings?.gecko?.id,manifest:o,management:{id:o.browser_specific_settings?.gecko?.id,mayDisable:!0,optionsUrl:"",installType:"development",type:"extension",enabled:!0,name:o.name,description:o.description||"",version:o.version,hostPermissions:o.host_permissions,permissions:o.permissions}}};this.options.stats===!0&&g.extensionData(e,n,!0),g.stdoutData(e,n),this.options.stats===!0&&setTimeout(()=>{g.isFirstRun()},2500)},6e3)}let r=_e(e,this.options);e.hooks.watchRun.tapAsync("RunFirefoxExtensionPlugin (CreateWebSocketServer)",(o,n)=>{let a=(o.modifiedFiles||new Set).values().next().value;if(!a){n();return}let u=R.default.relative(R.default.dirname(this.options.manifestPath||""),a),h=R.default.relative(process.cwd(),R.default.dirname(a));process.env.EXTENSION_ENV==="development"&&console.info(`\u25BA\u25BA Updated file \`${u}\` (relative to ${h})`),this.options.manifestPath&&z(r,this.options,a),n()})}};var B=require("webpack");var ee=c(require("content-security-policy-parser"));function Pe(t){let e=t.content_security_policy;if(!e)return"script-src 'self' 'unsafe-eval' blob: filesystem:; object-src 'self' blob: filesystem:; ";let r=(0,ee.default)(e);e="",r.get("script-src")||r.set("script-src",["'self' 'unsafe-eval' blob: filesystem:"]),r.get("script-src")?.includes("'unsafe-eval'")||r.set("script-src",["unsafe-eval"]);for(let o in r)e+=`${o} ${r.get(o)?.join(" ")};`;return e}function De(t){let e=t.content_security_policy;if(!e)return{extension_pages:"script-src 'self'; object-src 'self'; "};let r=(0,ee.default)(e.extension_pages),o="";for(let n in r)o+=`${n} ${r.get(n)?.join(" ")}; `;return{extension_pages:o.trim()}}function re(t){return`${require(t).name.toLowerCase().replace(/[^a-z0-9-]/g,"-")}@extension-js`}function Me(t){let e=["/*.json","/*.js","/*.css"],r=t.web_accessible_resources;if(!r||r.length===0)return e;let o=new Set(r);for(let n of e)o.add(n);return Array.from(o)}function je(t){let e=["/*.json","/*.js","/*.css"],r=t.web_accessible_resources;return!r||r.length===0?[{resources:e,matches:["<all_urls>"]}]:r.map(n=>{let s=new Set(n.resources);return e.forEach(a=>{n&&n.resources&&(n.resources.includes(a)||s.add(a))}),{...n,resources:Array.from(s)}})}var m=require("@colors/colors/safe");function te(t){if(!t.background){if(t.manifest_version===2)return{background:{...t.background,scripts:["background/script.js"]}};if(t.manifest_version===3)return{background:{...t.background,scripts:["background/service_worker.js"]}}}return t.background.service_worker?(console.warn(`${(0,m.bgWhite)((0,m.red)((0,m.bold)(" firefox-browser ")))} ${(0,m.yellow)("\u25BA\u25BA\u25BA")} Firefox does not support the ${(0,m.yellow)("background.service_worker")} field yet.
See ${(0,m.blue)((0,m.underline)("https://bugzilla.mozilla.org/show_bug.cgi?id=1573659"))}.

This program applies a workaround to make it run, but the service worker will not be registered.
Update your ${(0,m.yellow)("manifest.json")} file to use ${(0,m.yellow)("background.scripts")} instead.`),{background:{...t.background,scripts:["background/service_worker.js"]}}):{background:{...t.background}}}function oe(t){return t.externally_connectable&&!t.externally_connectable.ids?{externally_connectable:{...t.externally_connectable,ids:[...new Set(t.externally_connectable.ids||[]),"*"]}}:t.externally_connectable&&!t.externally_connectable.ids?{externally_connectable:{...t.externally_connectable,ids:["*"]}}:{}}function Ce(t,e){if(t.getAsset("manifest.json")||t.assets["manifest.json"]){let r=t.assets["manifest.json"].source().toString();return JSON.parse(r||"{}")}return require(e)}var ne=class{manifestPath;constructor(e){this.manifestPath=e.manifestPath}generateManifestPatches(e){let r=Ce(e,this.manifestPath),o={...r,content_security_policy:r.manifest_version===3?De(r):Pe(r),...r.manifest_version===3?r.permissions?{permissions:[...new Set(["scripting",...r.permissions])]}:{permissions:["scripting"]}:{},...te(r),...oe(r),web_accessible_resources:r.manifest_version===3?je(r):Me(r),browser_specific_settings:{gecko:{id:re(this.manifestPath)}}},n=JSON.stringify(o,null,2),s=new B.sources.RawSource(n);e.getAsset("manifest.json")&&e.updateAsset("manifest.json",s)}apply(e){e.hooks.thisCompilation.tap("RunFirefoxExtension (ApplyManifestDevDefaults)",r=>{let o=e.webpack.WebpackError;r.hooks.processAssets.tap({name:"RunFirefoxExtension (ApplyManifestDevDefaults)",stage:B.Compilation.PROCESS_ASSETS_STAGE_SUMMARIZE},n=>{if(!this.manifestPath){let s="No manifest.json found in your extension bundle. Unable to patch manifest.json.";r&&o&&r.errors.push(new o(`[RunFirefoxExtension (ApplyManifestDevDefaults)]: ${s}`));return}this.generateManifestPatches(r)})})}},Ie=ne;var se=c(require("fs")),S=c(require("path")),Ae=c(require("webpack-target-webextension")),T=require("@colors/colors/safe");var ie=class{manifestPath;constructor(e){this.manifestPath=e.manifestPath}handleBackground(e,r){let o=S.default.resolve(__dirname,"minimum-background-file.mjs"),n=S.default.dirname(this.manifestPath),s=r.background;if(r.manifest_version===3){let a=s&&s.service_worker;if(a){let u=S.default.join(n,a);this.ensureFileExists(u,"background.service_worker")}else this.addDefaultEntry(e,"background/service_worker",o)}else if(r.manifest_version===2){let a=s&&s.scripts;if(a&&a.length>0){let u=S.default.join(n,a[0]);this.ensureFileExists(u,"background.scripts")}else this.addDefaultEntry(e,"background/script",o)}}ensureFileExists(e,r){if(!se.default.existsSync(e)){let o=g.manifestFieldError(r,e);throw console.error((0,T.red)((0,T.bold)(o))),new Error(o)}}addDefaultEntry(e,r,o){e.options.entry={...e.options.entry,[r]:{import:[o]}}}getEntryName(e){if(e.background){if(e.manifest_version===3)return{serviceWorkerEntry:"background/service_worker"};if(e.manifest_version===2)return{pageEntry:"background/script"}}return{pageEntry:"background"}}apply(e){if(!this.manifestPath||!se.default.lstatSync(this.manifestPath).isFile())return;let r=require(this.manifestPath);this.handleBackground(e,r),new Ae.default({background:this.getEntryName(r),weakRuntimeCheck:!0}).apply(e)}},Ne=ie;var Be=c(require("path"));function ae(t,e){t.options.module.rules.push({test:/\.(t|j)sx?$/,use:[{loader:Be.default.resolve(__dirname,"./loaders/InjectBackgroundRuntimeLoader"),options:{manifestPath:e}}]})}var ce=class{manifestPath;constructor(e){this.manifestPath=e.manifestPath}apply(e){ae(e,this.manifestPath),new Ie({manifestPath:this.manifestPath}).apply(e),new Ne({manifestPath:this.manifestPath}).apply(e)}},Te=ce;var He=c(require("fs")),Ye=require("child_process"),p=require("@colors/colors/safe");var F=c(require("fs")),q=c(require("path")),qe=c(require("os")),Oe=c(require("which")),We=process.platform==="darwin",xr=process.platform==="win32",yr=!We&&!xr;function wr(){if(yr)try{return Oe.default.sync("firefox")}catch{return null}else if(We){let t="/Applications/Firefox.app/Contents/MacOS/firefox",e=q.default.join(qe.default.homedir(),t.slice(1));return F.default.existsSync(t)?t:F.default.existsSync(e)?e:null}else{let t=q.default.join("Mozilla Firefox","firefox.exe"),e=[process.env.LOCALAPPDATA,process.env.PROGRAMFILES,process.env["PROGRAMFILES(X86)"]];for(let o of e)if(o){let n=q.default.join(o,t);if(F.default.existsSync(n))return n}let r=["C:\\Program Files\\Mozilla Firefox\\firefox.exe","C:\\Program Files (x86)\\Mozilla Firefox\\firefox.exe"];for(let o of r)if(F.default.existsSync(o))return o;return null}}var vr=wr(),P=vr;var ze=c(require("path")),O=c(require("fs")),le=c(require("firefox-profile"));var Er={"app.update.enabled":!1,"browser.dom.window.dump.enabled":!0,"browser.formfill.enable":!1,"browser.link.open_newwindow":3,"browser.sessionstore.enabled":!1,"browser.shell.checkDefaultBrowser":!1,"browser.sync.enabled":!1,"browser.startup.page":0,"browser.startup.homepage_welcome_url":"about:blank","browser.startup.homepage_welcome_url_additional":"about:blank","browser.urlbar.suggest.bookmark":!1,"browser.urlbar.suggest.clipboard":!1,"browser.urlbar.suggest.history":!1,"browser.urlbar.suggest.openpage":!1,"browser.urlbar.suggest.remotetab":!1,"browser.urlbar.suggest.searches":!1,"browser.urlbar.suggest.topsites":!1,"browser.urlbar.suggest.engines":!1,"browser.urlbar.suggest.calculator":!1,"browser.urlbar.suggest.recentsearches":!1,"datareporting.policy.dataSubmissionEnabled":!1,"datareporting.policy.firstRunURL":"","devtools.browserconsole.contentMessages":!0,"devtools.chrome.enabled":!0,"devtools.debugger.prompt-connection":!1,"devtools.debugger.remote-enabled":!0,"devtools.errorconsole.enabled":!0,"extensions.installDistroAddons":!1,"extensions.autoDisableScopes":10,"extensions.chrome.enabled":!0,"extensions.logging.enabled":!1,"extensions.checkCompatibility.nightly":!1,"extensions.update.enabled":!1,"extensions.update.notifyUser":!1,"extensions.enabledScopes":5,"extensions.getAddons.cache.enabled":!1,"network.prefetch.next":!1,"network.speculative.preconnect.enabled":!1,"toolkit.telemetry.enabled":!1,"toolkit.telemetry.archive.enabled":!1,"toolkit.telemetry.newProfilePing.enabled":!1,"toolkit.recovery.enabled":!1,"urlclassifier.updateinterval":172800,"security.enterprise_roots.enabled":!0,"xpinstall.signatures.required":!1};function Le(t){return{...Er,...t}}var y=require("@colors/colors/safe");var Ue=c(require("progress"));function fe(t,e){let o=new Ue.default(`${t} [:bar] :percent :etas`,{complete:"=",incomplete:" ",width:50,total:131072}),n=setInterval(()=>{let s=Math.random()*10*1024;o.tick(s),o.complete&&(clearInterval(n),e())},50)}function Ve(t,e){let r=Le(e);Object.keys(r).forEach(s=>{t.setPreference(s,r[s])});let n=Object.keys(e);return n.length>0&&n.forEach(s=>{t.setPreference(s,e[s])}),t.updatePreferences(),t}function $r(t,e){let r=new le.default({destinationDirectory:t});return Ve(r,e)}function kr(t,e){let r;if(O.default.statSync(t).isDirectory())r=t;else throw new Error(`${(0,y.bgWhite)((0,y.red)(" chrome-browser "))} ${(0,y.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} The path ${t} is not a directory. Please provide a valid directory path.`);let n=new le.default({destinationDirectory:r});return Ve(n,e)}function pe(t,e,r){let o,n=t||ze.default.resolve(__dirname,"run-firefox-data-dir");return O.default.existsSync(n)?o=kr(n,e||{}):(r||fe(`\u{1F464} Creating ${(0,y.bold)("Firefox")} user data directory...`,()=>{}),O.default.mkdirSync(n,{recursive:!0}),o=$r(n,e||{})),o}async function ue(t){let{startingUrl:e,preferences:r,userDataDir:o,browserConsole:n=!1,browserFlags:s=[]}=t,a=pe(o,r),u=[];return e&&u.push(`--url "${e}"`),n&&u.push("--jsconsole"),s&&u.push(...s),[`--binary-args "${s.join(" ")}"`,`--profile "${a.path()}"`,`--listen ${t.port+100}`,"--verbose"].join(" ")}var W=c(require("path")),d=require("@colors/colors/safe");var Je=c(require("net")),Ge=c(require("events")),f=require("@colors/colors/safe");function Rr(t){let e=t.toString(),r=e.indexOf(":");if(r<1)return{remainingData:t};let o=parseInt(e.substring(0,r),10);if(isNaN(o))return{remainingData:t,error:new Error(`${(0,f.bgWhite)((0,f.red)((0,f.bold)(" firefox-browser ")))} ${(0,f.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Error parsing message length.`),fatal:!0};if(t.length-(r+1)<o)return{remainingData:t};let n=t.slice(r+1,r+1+o),s=t.slice(r+1+o);try{let a=JSON.parse(n.toString());return{remainingData:s,parsedMessage:a}}catch(a){return{remainingData:s,error:a,fatal:!1}}}var D=class extends Ge.default{incomingData=Buffer.alloc(0);pendingRequests=[];activeRequests=new Map;connection;async connect(e){await new Promise((r,o)=>{try{let n={port:e,host:"127.0.0.1"},s=Je.default.createConnection(n,()=>{r()});this.connection=s,s.on("data",this.onData.bind(this)),s.on("error",o),s.on("end",this.onEnd.bind(this)),s.on("timeout",this.onTimeout.bind(this)),this.expectReply("root",{resolve:r,reject:o})}catch(n){o(n)}})}disconnect(){this.connection&&(this.connection.removeAllListeners(),this.connection.end(),this.rejectAllRequests(new Error(`${(0,f.bgWhite)((0,f.red)((0,f.bold)(" firefox-browser ")))} ${(0,f.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} MessagingClient connection closed.`)))}rejectAllRequests(e){this.activeRequests.forEach(r=>{r.reject(e)}),this.activeRequests.clear(),this.pendingRequests.forEach(({deferred:r})=>{r.reject(e)}),this.pendingRequests=[]}async request(e){let r=typeof e=="string"?{to:"root",type:e}:e;if(!r.to)throw new Error(`${(0,f.bgWhite)((0,f.red)((0,f.bold)(" firefox-browser ")))} ${(0,f.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Unexpected MessagingClient request without target actor: ${r.type}`);return await new Promise((o,n)=>{let s={resolve:o,reject:n};this.pendingRequests.push({request:r,deferred:s}),this.flushPendingRequests()})}flushPendingRequests(){this.pendingRequests=this.pendingRequests.filter(({request:e,deferred:r})=>{if(this.activeRequests.has(e.to))return!0;if(!this.connection)throw new Error(`${(0,f.bgWhite)((0,f.red)((0,f.bold)(" firefox-browser ")))} ${(0,f.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} MessagingClient connection closed.`);try{let o=`${Buffer.from(JSON.stringify(e)).length}:${JSON.stringify(e)}`;this.connection.write(o),this.expectReply(e.to,r)}catch(o){r.reject(o)}return!1})}expectReply(e,r){if(this.activeRequests.has(e))throw new Error(`${(0,f.bgWhite)((0,f.red)((0,f.bold)(" firefox-browser ")))} ${(0,f.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Target actor ${e} already has an active request.`);this.activeRequests.set(e,r)}onData(e){for(this.incomingData=Buffer.concat([this.incomingData,e]);this.readMessage(););}readMessage(){let{remainingData:e,parsedMessage:r,error:o,fatal:n}=Rr(this.incomingData);return this.incomingData=e,o?(this.emit("error",new Error(`${(0,f.bgWhite)((0,f.red)((0,f.bold)(" firefox-browser ")))} ${(0,f.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Error parsing packet: ${o}`)),n&&this.disconnect(),!n):r?(this.handleMessage(r),!0):!1}handleMessage(e){if(!e.from){this.emit("error",new Error(`${(0,f.bgWhite)((0,f.red)((0,f.bold)(" firefox-browser ")))} ${(0,f.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Message received without a sender actor: ${JSON.stringify(e)}`));return}let r=this.activeRequests.get(e.from);r?(this.activeRequests.delete(e.from),e.error?r.reject(e):r.resolve(e),this.flushPendingRequests()):this.emit("error",new Error(`${(0,f.bgWhite)((0,f.red)((0,f.bold)(" firefox-browser ")))} ${(0,f.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Received unexpected message: ${JSON.stringify(e)}`))}onError(e){this.emit("error",e)}onEnd(){this.emit("end")}onTimeout(){this.emit("timeout")}};var me=require("@colors/colors/safe");function Xe(t){return t instanceof Error?String(t):`${t.error}: ${t.message}`}function Ke(t,e){return Array.isArray(t)&&t.includes(e.code)?!0:e.code===t}var _r=150,Sr=1e3,Fr=W.default.resolve(__dirname,"extensions","manager-extension"),Pr=W.default.resolve(__dirname,"extensions","reload-extension"),M=class{options;constructor(e){this.options=e}async connectClient(e){let r;for(let o of Array.from({length:_r}))try{let n=new D;return await n.connect(e),n}catch(n){if(Ke("ECONNREFUSED",n))await new Promise(s=>setTimeout(s,Sr)),r=n;else throw console.error(`${(0,d.bgWhite)((0,d.red)((0,d.bold)(" firefox-browser ")))} ${(0,d.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} ${n.stack}`),n}throw console.error(`${(0,d.bgWhite)((0,d.red)((0,d.bold)(" firefox-browser ")))} ${(0,d.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Unable to connect to Firefox. Too many retries.`),r}async installAddons(){let{extensionPath:e,autoReload:r,port:o,devtools:n}=this.options,a=[e?.replace("manifest.json",""),Fr];r&&a.push(Pr);let u=await this.connectClient(o+100);for(let[h,C]of a.entries()){let v=W.default.join(C.replace(/"/g,"")),U=h===0&&n;try{let w=await u.request({to:"root",type:"getRoot"});await u.request({to:w.addonsActor,type:"installTemporaryAddon",addonPath:v,openDevTools:U})}catch(w){let E=Xe(w);throw new Error(`${(0,d.bgWhite)((0,d.red)((0,d.bold)(" firefox-browser ")))} Error while installing temporary addon: ${E}`)}}}};process.on("SIGINT",()=>{process.exit()});process.on("SIGTERM",()=>{process.exit()});var j=class{options;constructor(e){this.options=e}async launchFirefox(){let e=`fx-runner start --binary "${P}" --foreground --no-remote`;He.default.existsSync(P)||(console.error(`${(0,p.bgWhite)((0,p.red)(" firefox-browser "))} ${(0,p.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Firefox browser ${P!=="null"?`is not found at ${P}`:"is not installed."}. Either install Firefox or choose a different browser via ${(0,p.blue)("--browser")}.`),process.exit());let r=await ue(this.options),o=`${e} ${r}`,n=(0,Ye.exec)(o,(a,u,h)=>{if(a!=null)throw a;h.includes("Unable to move the cache")?console.log(`${(0,p.bgWhite)((0,p.red)((0,p.bold)(" firefox-browser ")))} ${(0,p.green)("\u25BA\u25BA\u25BA")} Firefox instance already running.`):(console.log(`${(0,p.bgWhite)((0,p.red)((0,p.bold)(" firefox-browser ")))} ${(0,p.green)("\u25BA\u25BA\u25BA")} Firefox instance exited.`),process.exit())});process.env.EXTENSION_ENV==="development"&&(n.stdout?.pipe(process.stdout),n.stderr?.pipe(process.stderr)),new M(this.options).installAddons().catch(a=>{console.error(`${(0,p.bgWhite)((0,p.red)((0,p.bold)(" firefox-browser ")))} ${(0,p.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Error injecting add-ons code into Firefox profile.`),console.error(a),process.exit()})}apply(e){let r=!1;e.hooks.afterEmit.tapAsync("RunFirefoxExtensionPlugin (FirefoxExtensionLauncher)",(o,n)=>{if(o.errors.length>0){n();return}if(r){n();return}this.launchFirefox().catch(s=>{console.error(`${(0,p.bgWhite)((0,p.red)((0,p.bold)(" firefox-browser ")))} ${(0,p.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Error launching Firefox.`),console.error(s),process.exit()}),r=!0,n()})}};var L=class{options;constructor(e){this.options={manifestPath:e.manifestPath,extensionPath:e.extensionPath,port:e.port||8002,browserFlags:e.browserFlags||[],userDataDir:e.userDataDir,startingUrl:e.startingUrl,autoReload:e.autoReload!=null?e.autoReload:!0,stats:e.stats!=null?e.stats:!0}}apply(e){new _(this.options).apply(e),new Te(this.options).apply(e),new j(this.options).apply(e)}};

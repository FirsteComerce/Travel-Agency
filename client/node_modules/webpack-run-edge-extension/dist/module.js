"use strict";var Me=Object.create;var E=Object.defineProperty;var De=Object.getOwnPropertyDescriptor;var Fe=Object.getOwnPropertyNames;var Ie=Object.getPrototypeOf,Be=Object.prototype.hasOwnProperty;var Ne=(r,e)=>{for(var t in e)E(r,t,{get:e[t],enumerable:!0})},Y=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of Fe(e))!Be.call(r,o)&&o!==t&&E(r,o,{get:()=>e[o],enumerable:!(n=De(e,o))||n.enumerable});return r};var a=(r,e,t)=>(t=r!=null?Me(Ie(r)):{},Y(e||!r||!r.__esModule?E(t,"default",{value:r,enumerable:!0}):t,r)),Ae=r=>Y(E({},"__esModule",{value:!0}),r);var Ye={};Ne(Ye,{default:()=>R});module.exports=Ae(Ye);var _=a(require("path"));var Z=a(require("path")),Q=a(require("ws")),v=a(require("browser-extension-manifest-fields"));function w(r,e){r.clients.forEach(t=>{t.readyState===Q.default.OPEN&&t.send(JSON.stringify(e))})}function j(r,e,t){if(!t||!e.manifestPath)return;let n=(0,v.default)(e.manifestPath).locales,o=(0,v.default)(e.manifestPath).scripts,i=(0,v.default)(e.manifestPath).json;Z.default.basename(t)==="manifest.json"&&w(r,{changedFile:"manifest.json"}),n?.forEach(c=>{c.includes(t)&&w(r,{changedFile:"_locales"})}),Object.entries(o).forEach(([c,f])=>{let g=Array.isArray(f)?f:[f];Object.values(g).flatMap(P=>P).includes(t)&&c==="background/service_worker"&&w(r,{changedFile:"service_worker"})}),Object.entries(i).forEach(([c,f])=>{f?.includes(t)&&c==="declarative_net_request"&&w(r,{changedFile:"declarative_net_request"})})}var ie=a(require("ws"));var re=a(require("path")),l=require("console"),s=require("@colors/colors/safe"),se=a(require("prefers-yarn"));var M=a(require("fs")),ee=a(require("path"));function te(r){let e=0,t=M.default.readdirSync(r);for(let n of t){let o=ee.default.join(r,n),i=M.default.statSync(o);i.isFile()?e+=i.size:i.isDirectory()&&(e+=te(o))}return e}function D(r){let e=te(r),t=["Bytes","KB","MB","GB","TB"],n=Math.floor(Math.log(e)/Math.log(1024));return`${(e/Math.pow(1024,n)).toFixed(1)} ${t[n]}`}function We(r,e){let t=`Check the ${(0,s.bold)(r)} field in your manifest.json file and try again.`;return`[manifest.json] File path ${(0,s.underline)(e)} not found. ${t}`}function Oe(){(0,l.log)(`
${(0,s.bold)("Error! Can't find the project's manifest file.")}

Check your extension ${(0,s.yellow)("manifest.json")} file and ensure its path points to
one of the options above, and try again.
`)}function Te(r,e,t){e.data||((0,l.error)(`[\u26D4\uFE0F] ${(0,s.bgCyan)((0,s.white)((0,s.bold)(" edge-browser ")))} ${(0,s.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} No data received from client.

Ensure your extension is enabled and that no hanging Edge instance is open then try again.`),process.exit(1));let n=r.options,{id:o,management:i}=e.data;i||process.env.EXTENSION_ENV==="development"&&(0,l.error)(`[\u26D4\uFE0F] ${(0,s.bgCyan)((0,s.white)((0,s.bold)(" edge-browser ")))} ${(0,s.green)("\u25BA\u25BA\u25BA")} No management API info received from client. Investigate.`);let{name:c,description:f,version:g,hostPermissions:d,permissions:P}=i,$e=re.default.join(n.context||"","manifest.json"),K=require($e),Re=K.permissions||[],Pe=(P||[]).map(C=>Re.includes(C)?C:`${C} (dev only)`),Ce=K.id===o,je=d&&d.length;(0,l.log)(""),(0,l.log)(`${(0,s.bold)("\u2022 Name:")} ${c}`),f&&(0,l.log)(`${(0,s.bold)("\u2022 Description:")} ${f}`),(0,l.log)(`${(0,s.bold)("\u2022 Version:")} ${g}`),(0,l.log)(`${(0,s.bold)("\u2022 Size:")} ${D(n.output.path||"dist")}`),(0,l.log)(`${(0,s.bold)("\u2022 ID:")} ${o} (${Ce?"permantent":"temporary"})`),je&&(0,l.log)(`${(0,s.bold)("\u2022 Host Permissions")}: ${d.sort().join(", ")}`),(0,l.log)(`${(0,s.bold)("\u2022 Permissions:")} ${Pe.sort().join(", ")}`||"(Using defaults)"),(0,l.log)(`${(0,s.bold)("\u2022 Settings URL")}: ${(0,s.underline)((0,s.blue)(`edge://extensions/?id=${o}`))}
`)}function Ve(r,e){let t=r.options,n=e.data?.management,o=(0,s.bgCyan)((0,s.white)((0,s.bold)(" edge-browser "))),i=t.mode==="production"?s.magenta:s.cyan;(0,l.log)(`${o} ${(0,s.green)("\u25BA\u25BA\u25BA")} Running Edge in ${(0,s.bold)(i(t.mode||"unknown"))} mode. Browser ${n?.type} ${(0,s.bold)(n?.enabled?"enabled":"disabled")}.`)}function Ue(){(0,l.log)(""),(0,l.log)("This is your first run using \u{1F9E9} Extension.js. Welcome! \u{1F389}"),(0,l.log)(`To start developing your extension, terminate this process and run ${(0,s.bold)((0,s.blue)((0,se.default)()?"yarn dev":"npm run dev"))}.`),(0,l.log)(`
\u{1F9E9} Learn more at ${(0,s.blue)((0,s.underline)("https://extension.js.org"))}`)}function ze(r,e){let t=e.toString();(0,l.log)(`[\u{1F613}] ${(0,s.bgCyan)((0,s.white)((0,s.bold)(" edge-browser ")))} ${(0,s.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Watch mode closed (code ${r}). ${t&&`

Reason!!! `+t+`
`}Exiting...
`)}function Le(r){(0,l.error)(`${(0,s.bgCyan)((0,s.white)((0,s.bold)(" edge-browser ")))} ${(0,s.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Edge not found at ${r}`)}function Je(r){r(`[\u26D4\uFE0F] ${(0,s.bgCyan)((0,s.white)((0,s.bold)(" edge-browser ")))} ${(0,s.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} WebSocket error`,r)}function qe(r,e){r(`[\u26D4\uFE0F] ${(0,s.bgCyan)((0,s.white)((0,s.bold)(" edge-browser ")))} ${(0,s.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Error parsing file: ${e}. Reason: ${r.message}`)}var u={manifestFieldError:We,manifestNotFound:Oe,extensionData:Te,stdoutData:Ve,isFirstRun:Ue,watchModeClosed:ze,browserNotFound:Le,webSocketError:Je,parseFileError:qe};var ne=a(require("path")),oe=a(require("fs"));function h(){return!oe.default.existsSync(ne.default.resolve(__dirname,"run-edge-data-dir"))}function ae(r,e,t){let n=new ie.default.Server({host:"localhost",port:t}),o=h();return n.on("connection",i=>{i.send(JSON.stringify({status:"serverReady"})),i.on("error",c=>{u.webSocketError(c),n.close()}),i.on("close",(c,f)=>{o||u.watchModeClosed(c,f),n.close()}),i.on("message",c=>{let f=JSON.parse(c.toString());f.status==="clientReady"&&(e===!0&&u.extensionData(r,f,o),u.stdoutData(r,f),e===!0&&o&&setTimeout(()=>{u.isFirstRun()},2500))})}),n}var ce=a(require("path")),F=a(require("fs"));function I(r){let e=ce.default.resolve(__dirname,"./extensions/reload-extension/reloadService.js");F.default.readFile(e,"utf8",(t,n)=>{if(t){console.error(`Error reading file: ${t.message}`);return}let o=n.replace(/__RELOAD_PORT__/g,r.toString());F.default.writeFile(e,o,"utf8",i=>{i&&console.error(`Error writing to file: ${i.message}`)})})}var fe=a(require("path")),B=a(require("fs"));function N(){let r=h(),e=fe.default.resolve(__dirname,"./extensions/manager-extension/initialTab.js");B.default.readFile(e,"utf8",(t,n)=>{if(t){console.error(`Error reading file: ${t.message}`);return}let o=n.replace(/__IS_FIRST_RUN__ = false/g,`__IS_FIRST_RUN__ = ${r}`.toString());B.default.writeFile(e,o,"utf8",i=>{i&&console.error(`Error writing to file: ${i.message}`)})})}var b=class{options;constructor(e){this.options=e}apply(e){if(!this.options.manifestPath)return;I(this.options.port||8001),N();let t=this.options.stats,n=ae(e,t,this.options.port);e.hooks.watchRun.tapAsync("RunEdgeExtensionPlugin (CreateWebSocketServer)",(o,i)=>{let f=(o.modifiedFiles||new Set).values().next().value;if(!f){i();return}let g=_.default.relative(_.default.dirname(this.options.manifestPath||""),f),d=_.default.relative(process.cwd(),_.default.dirname(f));process.env.EXTENSION_ENV==="development"&&console.info(`\u25BA\u25BA Updated file \`${g}\` (relative to ${d})`),this.options.manifestPath&&j(n,this.options,f),i()})}};var k=require("webpack");var A=a(require("content-security-policy-parser"));function le(r){let e=r.content_security_policy;if(!e)return"script-src 'self' 'unsafe-eval' blob: filesystem:; object-src 'self' blob: filesystem:; ";let t=(0,A.default)(e);e="",t.get("script-src")||t.set("script-src",["'self' 'unsafe-eval' blob: filesystem:"]),t.get("script-src")?.includes("'unsafe-eval'")||t.set("script-src",["unsafe-eval"]);for(let n in t)e+=`${n} ${t.get(n)?.join(" ")};`;return e}function pe(r){let e=r.content_security_policy;if(!e)return{extension_pages:"script-src 'self'; object-src 'self'; "};let t=(0,A.default)(e.extension_pages),n="";for(let o in t)n+=`${o} ${t.get(o)?.join(" ")}; `;return{extension_pages:n.trim()}}function ue(r){let e=["/*.json","/*.js","/*.css"],t=r.web_accessible_resources;if(!t||t.length===0)return e;let n=new Set(t);for(let o of e)n.add(o);return Array.from(n)}function me(r){let e=["/*.json","/*.js","/*.css"],t=r.web_accessible_resources;return!t||t.length===0?[{resources:e,matches:["<all_urls>"]}]:t.map(o=>{let i=new Set(o.resources);return e.forEach(c=>{o&&o.resources&&(o.resources.includes(c)||i.add(c))}),{...o,resources:Array.from(i)}})}function W(r){return r.background?{background:{...r.background}}:r.manifest_version===2?{background:{...r.background,scripts:["background/script.js"]}}:{background:{...r.background,service_worker:"background/service_worker.js"}}}function O(r){return r.externally_connectable&&!r.externally_connectable.ids?{externally_connectable:{...r.externally_connectable,ids:[...new Set(r.externally_connectable.ids||[]),"*"]}}:r.externally_connectable&&!r.externally_connectable.ids?{externally_connectable:{...r.externally_connectable,ids:["*"]}}:{}}function de(r,e){if(r.getAsset("manifest.json")||r.assets["manifest.json"]){let t=r.assets["manifest.json"].source().toString();return JSON.parse(t||"{}")}return require(e)}var T=class{manifestPath;constructor(e){this.manifestPath=e.manifestPath}generateManifestPatches(e){let t=de(e,this.manifestPath),n={...t,content_security_policy:t.manifest_version===3?pe(t):le(t),...t.manifest_version===3?t.permissions?{permissions:[...new Set(["scripting",...t.permissions])]}:{permissions:["scripting"]}:{},...W(t),...O(t),web_accessible_resources:t.manifest_version===3?me(t):ue(t)},o=JSON.stringify(n,null,2),i=new k.sources.RawSource(o);e.getAsset("manifest.json")&&e.updateAsset("manifest.json",i)}apply(e){e.hooks.thisCompilation.tap("RunChromeExtension (ApplyManifestDevDefaults)",t=>{let n=e.webpack.WebpackError;t.hooks.processAssets.tap({name:"RunChromeExtension (ApplyManifestDevDefaults)",stage:k.Compilation.PROCESS_ASSETS_STAGE_SUMMARIZE},o=>{if(!this.manifestPath){let i="No manifest.json found in your extension bundle. Unable to patch manifest.json.";t&&n&&t.errors.push(new n(`[RunChromeExtension (ApplyManifestDevDefaults)]: ${i}`));return}this.generateManifestPatches(t)})})}},ge=T;var V=a(require("fs")),y=a(require("path")),he=a(require("webpack-target-webextension")),S=require("@colors/colors/safe");var U=class{manifestPath;constructor(e){this.manifestPath=e.manifestPath}handleBackground(e,t){let n=y.default.resolve(__dirname,"minimum-background-file.mjs"),o=y.default.dirname(this.manifestPath),i=t.background;if(t.manifest_version===3){let c=i&&i.service_worker;if(c){let f=y.default.join(o,c);this.ensureFileExists(f,"background.service_worker")}else this.addDefaultEntry(e,"background/service_worker",n)}else if(t.manifest_version===2){let c=i&&i.scripts;if(c&&c.length>0){let f=y.default.join(o,c[0]);this.ensureFileExists(f,"background.scripts")}else this.addDefaultEntry(e,"background/script",n)}}ensureFileExists(e,t){if(!V.default.existsSync(e)){let n=u.manifestFieldError(t,e);throw console.error((0,S.red)((0,S.bold)(n))),new Error(n)}}addDefaultEntry(e,t,n){console.log(`Adding default script for ${t}`),e.options.entry={...e.options.entry,[t]:{import:[n]}}}getEntryName(e){if(e.background){if(e.manifest_version===3)return{serviceWorkerEntry:"background/service_worker"};if(e.manifest_version===2)return{pageEntry:"background/script"}}return{pageEntry:"background"}}apply(e){if(!this.manifestPath||!V.default.lstatSync(this.manifestPath).isFile())return;let t=require(this.manifestPath);this.handleBackground(e,t),new he.default({background:this.getEntryName(t),weakRuntimeCheck:!0}).apply(e)}},_e=U;var be=a(require("path"));function z(r,e){r.options.module.rules.push({test:/\.(t|j)sx?$/,use:[{loader:be.default.resolve(__dirname,"./loaders/InjectBackgroundRuntimeLoader"),options:{manifestPath:e}}]})}var L=class{manifestPath;constructor(e){this.manifestPath=e.manifestPath}apply(e){z(e,this.manifestPath),new ge({manifestPath:this.manifestPath}).apply(e),new _e({manifestPath:this.manifestPath}).apply(e)}},ye=L;var H=a(require("fs")),ve=a(require("path")),ke=require("child_process"),p=require("@colors/colors/safe"),Se=a(require("edge-location"));var G=a(require("path"));var m=a(require("path")),$=a(require("fs")),we=require("@colors/colors/safe");var xe=a(require("progress"));function J(r,e){let n=new xe.default(`${r} [:bar] :percent :etas`,{complete:"=",incomplete:" ",width:50,total:131072}),o=setInterval(()=>{let i=Math.random()*10*1024;n.tick(i),n.complete&&(clearInterval(o),e())},50)}var Xe={alternate_error_pages:{enabled:!1},autofill:{enabled:!1},browser:{check_default_browser:!1,default_browser_setting_enabled:!1},default_apps:"install",distribution:{alternate_shortcut_text:!1,auto_launch_chrome:!1,import_bookmarks:!1,import_history:!1,import_home_page:!1,import_search_engine:!1,suppress_first_run_bubble:!0,do_not_register_for_update_launch:!0,make_chrome_default:!1,make_chrome_default_for_user:!1,require_eula:!1,suppress_first_run_default_browser_prompt:!0},dns_prefetching:{enabled:!1},download:{default_directory:"/tmp/",directory_upgrade:!0,open_pdf_in_adobe_reader:!1,prompt_for_download:!0},enable_do_not_track:!0,extensions:{theme:{use_system:!1},toolbarsize:-1,ui:{developer_mode:!0}},plugins:{plugins_list:[{enabled:!1,name:"Java(TM)"}],show_details:!0},profile:{password_manager_enabled:!1},safebrowsing:{enabled:!1,safebrowsingextended_reporting_enabled:!1},savefile:{default_directory:"/tmp",type:0},search:{suggest_enabled:!1},session:{restore_on_startup:1},sync:{suppress_start:!0},sync_promo:{show_on_first_run_allowed:!1,show_ntp_bubble:!1},translate:{enabled:!1}},Ee=Xe;function q(r,e){if(r||$.default.existsSync(m.default.resolve(__dirname,"run-edge-data-dir")))return r||m.default.resolve(__dirname,"run-edge-data-dir");let t=JSON.stringify(Ee);return e||J(`\u{1F464} Creating ${(0,we.bold)("Edge")} user data directory...`,()=>{let n=m.default.resolve(__dirname,"run-edge-data-dir"),o=m.default.join(n,"Default");$.default.mkdirSync(o,{recursive:!0});let i=m.default.join(o,"Preferences");$.default.writeFileSync(i,t,"utf8")}),m.default.resolve(__dirname,"run-edge-data-dir")}var He=G.default.resolve(__dirname,"extensions","manager-extension"),Ke=G.default.resolve(__dirname,"extensions","reload-extension");function X(r){let t=[r.extensionPath?.replace("manifest.json",""),He];return r.autoReload&&t.push(Ke),[`--load-extension=${t.join()}`,`--user-data-dir=${q(r.userDataDir)}`,"--no-first-run",...r.browserFlags||[]]}process.on("SIGINT",()=>{process.exit()});process.on("SIGTERM",()=>{process.exit()});var x=class{options;constructor(e){this.options=e}launchEdge(){let e=(0,Se.default)();H.default.existsSync(ve.default.resolve(e))||(console.error(`${(0,p.bgCyan)((0,p.white)((0,p.bold)(" edge-browser ")))} ${(0,p.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Edge not found at ${e}`),process.exit()),H.default.existsSync(e)||(console.error(`${(0,p.bgCyan)((0,p.white)((0,p.bold)(" edge-browser ")))} ${(0,p.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Edge browser ${typeof e>"u"?"is not installed.":`is not found at ${e}`}. Either install Edge or choose a different browser via ${(0,p.blue)("--browser")}.`),process.exit());let t=X(this.options),n=[this.options.startingUrl||"",...t],o=(0,ke.spawn)(e,n,{stdio:"inherit"});process.env.EXTENSION_ENV==="development"&&(o.stdout?.pipe(process.stdout),o.stderr?.pipe(process.stderr))}apply(e){let t=!1;e.hooks.afterEmit.tapAsync("RunEdgeExtensionPlugin (EdgeExtensionLauncher)",(n,o)=>{if(n.errors.length>0){o();return}if(t){o();return}this.launchEdge(),t=!0,o()})}};var R=class{options;constructor(e){this.options={manifestPath:e.manifestPath,extensionPath:e.extensionPath,port:e.port||8001,browserFlags:e.browserFlags||[],userDataDir:e.userDataDir,startingUrl:e.startingUrl,autoReload:e.autoReload!=null?e.autoReload:!0,stats:e.stats!=null?e.stats:!0}}apply(e){new b(this.options).apply(e),new ye(this.options).apply(e),new x(this.options).apply(e)}};

"use strict";var Me=Object.create;var w=Object.defineProperty;var De=Object.getOwnPropertyDescriptor;var Fe=Object.getOwnPropertyNames;var Ie=Object.getPrototypeOf,Be=Object.prototype.hasOwnProperty;var Ne=(r,e)=>{for(var t in e)w(r,t,{get:e[t],enumerable:!0})},Y=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Fe(e))!Be.call(r,n)&&n!==t&&w(r,n,{get:()=>e[n],enumerable:!(s=De(e,n))||s.enumerable});return r};var a=(r,e,t)=>(t=r!=null?Me(Ie(r)):{},Y(e||!r||!r.__esModule?w(t,"default",{value:r,enumerable:!0}):t,r)),Ae=r=>Y(w({},"__esModule",{value:!0}),r);var Ye={};Ne(Ye,{default:()=>C});module.exports=Ae(Ye);var _=a(require("path"));var Z=a(require("path")),Q=a(require("ws")),v=a(require("browser-extension-manifest-fields"));function k(r,e){r.clients.forEach(t=>{t.readyState===Q.default.OPEN&&t.send(JSON.stringify(e))})}function j(r,e,t){if(!t||!e.manifestPath)return;let s=(0,v.default)(e.manifestPath).locales,n=(0,v.default)(e.manifestPath).scripts,i=(0,v.default)(e.manifestPath).json;Z.default.basename(t)==="manifest.json"&&k(r,{changedFile:"manifest.json"}),s?.forEach(c=>{c.includes(t)&&k(r,{changedFile:"_locales"})}),Object.entries(n).forEach(([c,f])=>{let h=Array.isArray(f)?f:[f];Object.values(h).flatMap(R=>R).includes(t)&&c==="background/service_worker"&&k(r,{changedFile:"service_worker"})}),Object.entries(i).forEach(([c,f])=>{f?.includes(t)&&c==="declarative_net_request"&&k(r,{changedFile:"declarative_net_request"})})}var ie=a(require("ws"));var re=a(require("path")),m=require("console"),o=require("@colors/colors/safe"),se=a(require("prefers-yarn"));var M=a(require("fs")),ee=a(require("path"));function te(r){let e=0,t=M.default.readdirSync(r);for(let s of t){let n=ee.default.join(r,s),i=M.default.statSync(n);i.isFile()?e+=i.size:i.isDirectory()&&(e+=te(n))}return e}function D(r){let e=te(r),t=["Bytes","KB","MB","GB","TB"],s=Math.floor(Math.log(e)/Math.log(1024));return`${(e/Math.pow(1024,s)).toFixed(1)} ${t[s]}`}function We(r,e){let t=`Check the ${(0,o.bold)(r)} field in your manifest.json file and try again.`;return`[manifest.json] File path ${(0,o.underline)(e)} not found. ${t}`}function Oe(){(0,m.log)(`
${(0,o.bold)("Error! Can't find the project's manifest file.")}

Check your extension ${(0,o.yellow)("manifest.json")} file and ensure its path points to
one of the options above, and try again.
`)}function Te(r,e,t){e.data||((0,m.error)(`[\u26D4\uFE0F] ${(0,o.bgWhite)((0,o.bold)(" chrome-browser "))} ${(0,o.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} No data received from client.

Ensure your extension is enabled and that no hanging Chrome instance is open then try again.`),process.exit(1));let s=r.options,{id:n,management:i}=e.data;i||process.env.EXTENSION_ENV==="development"&&(0,m.error)(`[\u26D4\uFE0F] ${(0,o.bgWhite)((0,o.bold)(" chrome-browser "))} ${(0,o.green)("\u25BA\u25BA\u25BA")} No management API info received from client. Investigate.`);let{name:c,description:f,version:h,hostPermissions:d,permissions:R}=i,$e=re.default.join(s.context||"","manifest.json"),K=require($e),Ce=K.permissions||[],Re=(R||[]).map(P=>Ce.includes(P)?P:`${P} (dev only)`),Pe=K.id===n,je=d&&d.length;(0,m.log)(""),(0,m.log)(`${(0,o.bold)("\u2022 Name:")} ${c}`),f&&(0,m.log)(`${(0,o.bold)("\u2022 Description:")} ${f}`),(0,m.log)(`${(0,o.bold)("\u2022 Version:")} ${h}`),(0,m.log)(`${(0,o.bold)("\u2022 Size:")} ${D(s.output.path||"dist")}`),(0,m.log)(`${(0,o.bold)("\u2022 ID:")} ${n} (${Pe?"permantent":"temporary"})`),je&&(0,m.log)(`${(0,o.bold)("\u2022 Host Permissions")}: ${d.sort().join(", ")}`),(0,m.log)(`${(0,o.bold)("\u2022 Permissions:")} ${Re.sort().join(", ")}`||"(Using defaults)"),(0,m.log)(`${(0,o.bold)("\u2022 Settings URL")}: ${(0,o.underline)((0,o.blue)(`chrome://extensions/?id=${n}`))}
`)}function Ve(r,e){let t=r.options,s=e.data?.management,n=(0,o.bgWhite)((0,o.black)((0,o.bold)(" chrome-browser "))),i=t.mode==="production"?o.magenta:o.cyan;(0,m.log)(`${n} ${(0,o.green)("\u25BA\u25BA\u25BA")} Running Chrome in ${(0,o.bold)(i(t.mode||"unknown"))} mode. Browser ${s?.type} ${(0,o.bold)(s?.enabled?"enabled":"disabled")}.`)}function Ue(){(0,m.log)(""),(0,m.log)("This is your first run using \u{1F9E9} Extension.js. Welcome! \u{1F389}"),(0,m.log)(`To start developing your extension, terminate this process and run ${(0,o.bold)((0,o.blue)((0,se.default)()?"yarn dev":"npm run dev"))}.`),(0,m.log)(`
\u{1F9E9} Learn more at ${(0,o.blue)((0,o.underline)("https://extension.js.org"))}`)}function ze(r,e){let t=e.toString();(0,m.log)(`[\u{1F613}] ${(0,o.bgWhite)((0,o.bold)(" chrome-browser "))} ${(0,o.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Watch mode closed (code ${r}). ${t&&`

Reason `+t+`
`}Exiting...
`)}function Le(r){(0,m.error)(`${(0,o.bgWhite)((0,o.bold)(" chrome-browser "))} ${(0,o.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Chrome not found at ${r}`)}function Je(r){r(`[\u26D4\uFE0F] ${(0,o.bgWhite)((0,o.bold)(" chrome-browser "))} ${(0,o.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} WebSocket error`,r)}function qe(r,e){r(`[\u26D4\uFE0F] ${(0,o.bgWhite)((0,o.bold)(" chrome-browser "))} ${(0,o.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Error parsing file: ${e}. Reason: ${r.message}`)}var p={manifestFieldError:We,manifestNotFound:Oe,extensionData:Te,stdoutData:Ve,isFirstRun:Ue,watchModeClosed:ze,browserNotFound:Le,webSocketError:Je,parseFileError:qe};var ne=a(require("path")),oe=a(require("fs"));function g(){return!oe.default.existsSync(ne.default.resolve(__dirname,"run-chrome-data-dir"))}function ae(r,e,t){let s=new ie.default.Server({host:"localhost",port:t}),n=g();return s.on("connection",i=>{i.send(JSON.stringify({status:"serverReady"})),i.on("error",c=>{p.webSocketError(c),s.close()}),i.on("close",(c,f)=>{n||p.watchModeClosed(c,f),s.close()}),i.on("message",c=>{let f=JSON.parse(c.toString());f.status==="clientReady"&&(e===!0&&p.extensionData(r,f,n),p.stdoutData(r,f),e===!0&&n&&setTimeout(()=>{p.isFirstRun()},2500))})}),s}var ce=a(require("path")),F=a(require("fs"));function I(r){let e=ce.default.resolve(__dirname,"./extensions/reload-extension/reloadService.js");F.default.readFile(e,"utf8",(t,s)=>{if(t){console.error(`Error reading file: ${t.message}`);return}let n=s.replace(/__RELOAD_PORT__/g,r.toString());F.default.writeFile(e,n,"utf8",i=>{i&&console.error(`Error writing to file: ${i.message}`)})})}var fe=a(require("path")),B=a(require("fs"));function N(){let r=g(),e=fe.default.resolve(__dirname,"./extensions/manager-extension/initialTab.js");B.default.readFile(e,"utf8",(t,s)=>{if(t){console.error(`Error reading file: ${t.message}`);return}let n=s.replace(/__IS_FIRST_RUN__ = false/g,`__IS_FIRST_RUN__ = ${r}`.toString());B.default.writeFile(e,n,"utf8",i=>{i&&console.error(`Error writing to file: ${i.message}`)})})}var b=class{options;constructor(e){this.options=e}apply(e){if(!this.options.manifestPath)return;I(this.options.port||8e3),N();let t=this.options.stats,s=ae(e,t,this.options.port);e.hooks.watchRun.tapAsync("RunChromeExtensionPlugin (CreateWebSocketServer)",(n,i)=>{let f=(n.modifiedFiles||new Set).values().next().value;if(!f){i();return}let h=_.default.relative(_.default.dirname(this.options.manifestPath||""),f),d=_.default.relative(process.cwd(),_.default.dirname(f));process.env.EXTENSION_ENV==="development"&&console.info(`\u25BA\u25BA Updated file \`${h}\` (relative to ${d})`),this.options.manifestPath&&j(s,this.options,f),i()})}};var E=require("webpack");var A=a(require("content-security-policy-parser"));function me(r){let e=r.content_security_policy;if(!e)return"script-src 'self' 'unsafe-eval' blob: filesystem:; object-src 'self' blob: filesystem:; ";let t=(0,A.default)(e);e="",t.get("script-src")||t.set("script-src",["'self' 'unsafe-eval' blob: filesystem:"]),t.get("script-src")?.includes("'unsafe-eval'")||t.set("script-src",["unsafe-eval"]);for(let s in t)e+=`${s} ${t.get(s)?.join(" ")};`;return e}function le(r){let e=r.content_security_policy;if(!e)return{extension_pages:"script-src 'self'; object-src 'self'; "};let t=(0,A.default)(e.extension_pages),s="";for(let n in t)s+=`${n} ${t.get(n)?.join(" ")}; `;return{extension_pages:s.trim()}}function pe(r){let e=["/*.json","/*.js","/*.css"],t=r.web_accessible_resources;if(!t||t.length===0)return e;let s=new Set(t);for(let n of e)s.add(n);return Array.from(s)}function ue(r){let e=["/*.json","/*.js","/*.css"],t=r.web_accessible_resources;return!t||t.length===0?[{resources:e,matches:["<all_urls>"]}]:t.map(n=>{let i=new Set(n.resources);return e.forEach(c=>{n&&n.resources&&(n.resources.includes(c)||i.add(c))}),{...n,resources:Array.from(i)}})}function W(r){return r.background?{background:{...r.background}}:r.manifest_version===2?{background:{...r.background,scripts:["background/script.js"]}}:{background:{...r.background,service_worker:"background/service_worker.js"}}}function O(r){return r.externally_connectable&&!r.externally_connectable.ids?{externally_connectable:{...r.externally_connectable,ids:[...new Set(r.externally_connectable.ids||[]),"*"]}}:r.externally_connectable&&!r.externally_connectable.ids?{externally_connectable:{...r.externally_connectable,ids:["*"]}}:{}}function de(r,e){if(r.getAsset("manifest.json")||r.assets["manifest.json"]){let t=r.assets["manifest.json"].source().toString();return JSON.parse(t||"{}")}return require(e)}var T=class{manifestPath;constructor(e){this.manifestPath=e.manifestPath}generateManifestPatches(e){let t=de(e,this.manifestPath),s={...t,content_security_policy:t.manifest_version===3?le(t):me(t),...t.manifest_version===3?t.permissions?{permissions:[...new Set(["scripting",...t.permissions])]}:{permissions:["scripting"]}:{},...W(t),...O(t),web_accessible_resources:t.manifest_version===3?ue(t):pe(t)},n=JSON.stringify(s,null,2),i=new E.sources.RawSource(n);e.getAsset("manifest.json")&&e.updateAsset("manifest.json",i)}apply(e){e.hooks.thisCompilation.tap("RunChromeExtension (ApplyManifestDevDefaults)",t=>{let s=e.webpack.WebpackError;t.hooks.processAssets.tap({name:"RunChromeExtension (ApplyManifestDevDefaults)",stage:E.Compilation.PROCESS_ASSETS_STAGE_SUMMARIZE},n=>{if(!this.manifestPath){let i="No manifest.json found in your extension bundle. Unable to patch manifest.json.";t&&s&&t.errors.push(new s(`[RunChromeExtension (ApplyManifestDevDefaults)]: ${i}`));return}this.generateManifestPatches(t)})})}},he=T;var V=a(require("fs")),y=a(require("path")),ge=a(require("webpack-target-webextension")),S=require("@colors/colors/safe");var U=class{manifestPath;constructor(e){this.manifestPath=e.manifestPath}handleBackground(e,t){let s=y.default.resolve(__dirname,"minimum-background-file.mjs"),n=y.default.dirname(this.manifestPath),i=t.background;if(t.manifest_version===3){let c=i&&i.service_worker;if(c){let f=y.default.join(n,c);this.ensureFileExists(f,"background.service_worker")}else this.addDefaultEntry(e,"background/service_worker",s)}else if(t.manifest_version===2){let c=i&&i.scripts;if(c&&c.length>0){let f=y.default.join(n,c[0]);this.ensureFileExists(f,"background.scripts")}else this.addDefaultEntry(e,"background/script",s)}}ensureFileExists(e,t){if(!V.default.existsSync(e)){let s=p.manifestFieldError(t,e);throw console.error((0,S.red)((0,S.bold)(s))),new Error(s)}}addDefaultEntry(e,t,s){e.options.entry={...e.options.entry,[t]:{import:[s]}}}getEntryName(e){if(e.background){if(e.manifest_version===3)return{serviceWorkerEntry:"background/service_worker"};if(e.manifest_version===2)return{pageEntry:"background/script"}}return{pageEntry:"background"}}apply(e){if(!this.manifestPath||!V.default.lstatSync(this.manifestPath).isFile())return;let t=require(this.manifestPath);this.handleBackground(e,t),new ge.default({background:this.getEntryName(t),weakRuntimeCheck:!0}).apply(e)}},_e=U;var be=a(require("path"));function z(r,e){r.options.module.rules.push({test:/\.(t|j)sx?$/,use:[{loader:be.default.resolve(__dirname,"./loaders/InjectBackgroundRuntimeLoader"),options:{manifestPath:e}}]})}var L=class{manifestPath;constructor(e){this.manifestPath=e.manifestPath}apply(e){z(e,this.manifestPath),new he({manifestPath:this.manifestPath}).apply(e),new _e({manifestPath:this.manifestPath}).apply(e)}},ye=L;var H=a(require("fs")),ve=a(require("path")),Ee=require("child_process"),l=require("@colors/colors/safe"),Se=a(require("chrome-location"));var G=a(require("path"));var u=a(require("path")),$=a(require("fs")),ke=require("@colors/colors/safe");var xe=a(require("progress"));function J(r,e){let s=new xe.default(`${r} [:bar] :percent :etas`,{complete:"=",incomplete:" ",width:50,total:131072}),n=setInterval(()=>{let i=Math.random()*10*1024;s.tick(i),s.complete&&(clearInterval(n),e())},50)}var Xe={alternate_error_pages:{enabled:!1},autofill:{enabled:!1},browser:{check_default_browser:!1,default_browser_setting_enabled:!1},default_apps:"install",distribution:{alternate_shortcut_text:!1,auto_launch_chrome:!1,import_bookmarks:!1,import_history:!1,import_home_page:!1,import_search_engine:!1,suppress_first_run_bubble:!0,do_not_register_for_update_launch:!0,make_chrome_default:!1,make_chrome_default_for_user:!1,require_eula:!1,suppress_first_run_default_browser_prompt:!0},dns_prefetching:{enabled:!1},download:{default_directory:"/tmp/",directory_upgrade:!0,open_pdf_in_adobe_reader:!1,prompt_for_download:!0},enable_do_not_track:!0,extensions:{theme:{use_system:!1},toolbarsize:-1,ui:{developer_mode:!0}},plugins:{plugins_list:[{enabled:!1,name:"Java(TM)"}],show_details:!0},profile:{password_manager_enabled:!1},safebrowsing:{enabled:!1,safebrowsingextended_reporting_enabled:!1},savefile:{default_directory:"/tmp",type:0},search:{suggest_enabled:!1},session:{restore_on_startup:1},sync:{suppress_start:!0},sync_promo:{show_on_first_run_allowed:!1,show_ntp_bubble:!1},translate:{enabled:!1}},we=Xe;function q(r,e){if(r||$.default.existsSync(u.default.resolve(__dirname,"run-chrome-data-dir")))return r||u.default.resolve(__dirname,"run-chrome-data-dir");let t=JSON.stringify(we);return e||J(`\u{1F464} Creating ${(0,ke.bold)("Chrome")} user data directory...`,()=>{let s=u.default.resolve(__dirname,"run-chrome-data-dir"),n=u.default.join(s,"Default");$.default.mkdirSync(n,{recursive:!0});let i=u.default.join(n,"Preferences");$.default.writeFileSync(i,t,"utf8")}),u.default.resolve(__dirname,"run-chrome-data-dir")}var He=G.default.resolve(__dirname,"extensions","manager-extension"),Ke=G.default.resolve(__dirname,"extensions","reload-extension");function X(r){let t=[r.extensionPath?.replace("manifest.json",""),He];return r.autoReload&&t.push(Ke),[`--load-extension=${t.join()}`,`--user-data-dir=${q(r.userDataDir)}`,"--no-first-run",...r.browserFlags||[]]}process.on("SIGINT",()=>{process.exit()});process.on("SIGTERM",()=>{process.exit()});var x=class{options;constructor(e){this.options=e}launchChrome(){let e=Se.default;H.default.existsSync(ve.default.resolve(e))||(console.error(`${(0,l.bgWhite)((0,l.black)((0,l.bold)(" chrome-browser ")))} ${(0,l.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Chrome not found at ${e}`),process.exit()),H.default.existsSync(e)||(console.error(`${(0,l.bgWhite)((0,l.black)((0,l.bold)(" chrome-browser ")))} ${(0,l.red)("\u2716\uFE0E\u2716\uFE0E\u2716\uFE0E")} Chrome browser ${typeof e>"u"?"is not installed.":`is not found at ${e}`}. Either install Chrome or choose a different browser via ${(0,l.blue)("--browser")}.`),process.exit());let t=X(this.options),s=[this.options.startingUrl||"",...t],n=(0,Ee.spawn)(e,s,{stdio:"inherit"});process.env.EXTENSION_ENV==="development"&&(n.stdout?.pipe(process.stdout),n.stderr?.pipe(process.stderr))}apply(e){let t=!1;e.hooks.afterEmit.tapAsync("RunChromeExtensionPlugin (ChromeExtensionLauncher)",(s,n)=>{if(s.errors.length>0){n();return}if(t){n();return}this.launchChrome(),t=!0,n()})}};var C=class{options;constructor(e){this.options={manifestPath:e.manifestPath,extensionPath:e.extensionPath,port:e.port||8e3,browserFlags:e.browserFlags||[],userDataDir:e.userDataDir,startingUrl:e.startingUrl,autoReload:e.autoReload!=null?e.autoReload:!0,stats:e.stats!=null?e.stats:!0}}apply(e){new b(this.options).apply(e),new ye(this.options).apply(e),new x(this.options).apply(e)}};
